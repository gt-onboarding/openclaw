---
title: ボイスウェイク
summary: "mac アプリでの音声起動およびプッシュトゥトーク モードとルーティングの詳細"
read_when:
  - 音声起動または PTT (Push-to-Talk) のパスを実装・構成しているとき
---

<div id="voice-wake-push-to-talk">
  # 音声起動 & プッシュ・トゥー・トーク
</div>

<div id="modes">
  ## モード
</div>

- **ウェイクワード・モード**（デフォルト）：常時オンの音声認識エンジンがトリガートークン（`swabbleTriggerWords`）を待機します。一致するとキャプチャを開始し、オーバーレイに途中結果のテキストを表示し、無音状態になると自動的に送信されます。
- **プッシュ・トゥ・トーク（右 Option 長押し）**：右の Option キーを押し続けると、トリガーなしで即座にキャプチャを開始します。押している間はオーバーレイが表示され、キーを離すと確定され、テキストを微調整できるよう短い遅延の後に送信されます。

<div id="runtime-behavior-wake-word">
  ## ランタイム動作（ウェイクワード）
</div>

- 音声認識は `VoiceWakeRuntime` 内で動作します。
- トリガーは、ウェイクワードと次の単語の間に**十分なポーズ**（約 0.55 秒の間隔）がある場合にのみ発火します。オーバーレイ／チャイムは、コマンドが始まる前でも、そのポーズの時点から開始できます。
- 無音ウィンドウ: 発話が継続している場合は 2.0 秒、トリガーだけが検出された場合は 5.0 秒。
- ハードストップ: セッションの暴走を防ぐため 120 秒。
- セッション間のデバウンス間隔: 350ms。
- オーバーレイは `VoiceWakeOverlayController` によって、確定／未確定状態に応じた色付けで制御されます。
- 送信後、音声認識エンジンは次のトリガーを待ち受けるためにクリーンに再起動されます。

<div id="lifecycle-invariants">
  ## ライフサイクルにおける不変条件
</div>

- Voice Wake が有効で、必要な権限が付与されている場合は、（明示的なプッシュトゥトークのキャプチャ中を除き）ウェイクワード認識器は常に音声を待ち受けている必要があります。
- オーバーレイの表示状態（X ボタンによる手動での閉じる操作を含む）は、認識器の再開を決して妨げてはなりません。

<div id="sticky-overlay-failure-mode-previous">
  ## スティッキーオーバーレイの障害モード（以前）
</div>

以前は、オーバーレイが表示されたままになり、手動で閉じた場合でも、ランタイムによる再起動の試行がオーバーレイの表示状態によってブロックされ、その後の再起動もスケジュールされないため、Voice Wake が「死んでいる」ように見えることがありました。

堅牢化:

- Wake ランタイムの再起動は、オーバーレイの表示状態によってブロックされなくなりました。
- オーバーレイの閉じ処理完了時に、`VoiceSessionCoordinator` 経由で `VoiceWakeRuntime.refresh(...)` がトリガーされるため、手動で X ボタンで閉じても必ずリスニングが再開されます。

<div id="push-to-talk-specifics">
  ## プッシュトゥトークの詳細
</div>

- ホットキー検出には、**右Option**（`keyCode 61` + `.option`）用のグローバルな `.flagsChanged` モニターを使用します。イベントは監視するだけで（フックして抑止はしません）。
- キャプチャパイプラインは `VoicePushToTalk` 内にあり、即座に Speech を開始し、中間結果をオーバーレイへストリーミングし、キーが離されたタイミングで `VoiceWakeForwarder` を呼び出します。
- プッシュトゥトークが開始されると、オーディオタップの競合を避けるためにウェイクワードのランタイムを一時停止します。これはキーを離した後に自動的に再開されます。
- 権限: Microphone と Speech が必要です。イベントを取得するには、アクセシビリティ／入力監視の承認が必要です。
- 外付けキーボード: 一部のデバイスでは、右Optionキーが期待どおりに認識されない場合があります。ユーザーから取りこぼしの報告があった場合は、フォールバックのショートカットを提供してください。

<div id="user-facing-settings">
  ## ユーザー向け設定
</div>

- **Voice Wake** トグル: ウェイクワード機能を有効にします。
- **Cmd+Fn を押して話す**: プッシュ・トゥ・トーク監視機能を有効にします。macOS &lt; 26 では無効です。
- 言語およびマイクのピッカー、リアルタイムレベルメーター、トリガーワードテーブル、テスター（ローカル専用。転送は行いません）。
- マイクピッカーは、デバイスが切断された場合でも最後の選択を保持し、切断中であることを示すヒントを表示し、デバイスが戻るまで一時的にシステムデフォルトにフォールバックします。
- **サウンド**: トリガー検出時と送信時にチャイムを鳴らします。デフォルトは macOS の「Glass」システムサウンドです。各イベントごとに、`NSSound` でロード可能な任意のファイル（例: MP3/WAV/AIFF）を選択するか、**No Sound** を選択できます。

<div id="forwarding-behavior">
  ## 転送動作
</div>

- Voice Wake が有効な場合、文字起こしはアクティブな Gateway／エージェントに転送されます（macOS アプリの他の部分と同じローカル／リモートのモードが使われます）。
- 応答は **直近で使用されたメインプロバイダー**（WhatsApp/Telegram/Discord/WebChat）に配信されます。配信が失敗した場合でも、エラーはログに記録され、この実行は WebChat／セッションログから引き続き確認できます。

<div id="forwarding-payload">
  ## 転送ペイロード
</div>

- `VoiceWakeForwarder.prefixedTranscript(_:)` は、送信前にマシン向けのヒントを前置します。ウェイクワードおよびプッシュトゥトークの両パスで共通に使用されます。

<div id="quick-verification">
  ## クイック検証
</div>

- プッシュ・トゥ・トークをオンにし、Cmd+Fn を押し続けて話し、離す：オーバーレイに途中結果が表示され、最後に送信されるはずです。
- 押している間はメニューバーの耳アイコンが拡大されたままである必要があります（`triggerVoiceEars(ttl:nil)` を使用）。キーを離すと縮小します。