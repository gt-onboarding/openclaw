---
title: 厳格なコンフィグ
summary: "厳格なコンフィグ検証 + doctor 専用マイグレーション"
read_when:
  - コンフィグ検証の挙動を設計・実装しているとき
  - コンフィグのマイグレーションや doctor ワークフローに取り組んでいるとき
  - プラグインのコンフィグスキーマやプラグインの読み込み制御を扱っているとき
---

<div id="strict-config-validation-doctor-only-migrations">
  # 厳密な設定検証（doctor 専用マイグレーション）
</div>

<div id="goals">
  ## 目標
</div>

- **未知の設定キーをすべて拒否する**（ルートおよびすべてのネスト階層）。
- **スキーマを持たないプラグイン設定を拒否する**。そのプラグインは読み込まない。
- **ロード時のレガシー自動マイグレーションを廃止する**。マイグレーションは doctor 経由でのみ実行する。
- **起動時に doctor（ドライラン）を自動実行する**。設定が無効な場合は診断以外のコマンドをブロックする。

<div id="non-goals">
  ## 非目標
</div>

- ロード時の後方互換性（レガシーキーは自動的に移行されない）。
- 認識されないキーを黙って破棄すること。

<div id="strict-validation-rules">
  ## 厳格なバリデーションルール
</div>

- 設定はすべての階層でスキーマと完全に一致していなければならない。
- 不明なキーはすべてバリデーションエラーとなる（ルートおよびネストされた階層でのパススルーは不可）。
- `plugins.entries.<id>.config` はプラグインのスキーマでバリデートされなければならない。
  - プラグインにスキーマがない場合は、**プラグインの読み込みを拒否**し、わかりやすいエラーを出す。
- プラグインマニフェストがチャンネル ID を宣言していない限り、不明な `channels.<id>` キーはエラーとする。
- すべてのプラグインに対して、`openclaw.plugin.json` のプラグインマニフェストが必須である。

<div id="plugin-schema-enforcement">
  ## プラグインスキーマの厳格適用
</div>

- 各プラグインは、自身の設定用に厳密な JSON Schema を提供する（マニフェスト内にインラインで定義）。
- プラグインの読み込みフロー:
  1) プラグインマニフェストとスキーマ（`openclaw.plugin.json`）を取得する。
  2) 設定をスキーマに対して検証する。
  3) スキーマが存在しない、または設定が不正な場合: プラグインの読み込みをブロックし、エラーを記録する。
- エラーメッセージには次が含まれる:
  - プラグイン ID
  - 理由（スキーマ欠如 / 不正な設定）
  - 検証に失敗したパス
- 無効化されたプラグインも設定は保持されるが、Doctor とログに警告として表示される。

<div id="doctor-flow">
  ## Doctor フロー
</div>

- Doctor は、設定が読み込まれるたびに（デフォルトではドライランで）**毎回**実行されます。
- 設定が無効な場合:
  - 要約と、具体的な対処が可能なエラー内容を出力します。
  - 次のコマンドを実行するよう指示します: `openclaw doctor --fix`。
- `openclaw doctor --fix`:
  - マイグレーションを適用します。
  - 不明なキーを削除します。
  - 更新された設定を書き込みます。

<div id="command-gating-when-config-is-invalid">
  ## コマンド制限（設定が無効な場合）
</div>

許可されるコマンド（診断専用）:

- `openclaw doctor`
- `openclaw logs`
- `openclaw health`
- `openclaw help`
- `openclaw status`
- `openclaw gateway status`

それ以外のコマンドはすべて、次のエラーを出して即座に失敗させてください: 「設定が無効です。`openclaw doctor --fix` を実行してください。」

<div id="error-ux-format">
  ## エラー UX の形式
</div>

- 単一のサマリー見出し。
- セクション単位でのグルーピング:
  - 不明なキー（フルパス付き）
  - レガシーキー / 移行が必要なもの
  - プラグインの読み込み失敗（プラグイン ID + 理由 + パス）

<div id="implementation-touchpoints">
  ## 実装上の変更箇所
</div>

- `src/config/zod-schema.ts`: ルートのパススルーを削除し、すべてのオブジェクトを strict にする。
- `src/config/zod-schema.providers.ts`: チャネルスキーマが strict であることを保証する。
- `src/config/validation.ts`: 不明なキーで失敗させ、レガシー移行を適用しない。
- `src/config/io.ts`: レガシーの自動マイグレーションを削除し、常に doctor のドライランを実行する。
- `src/config/legacy*.ts`: 使用箇所を doctor のみに限定する。
- `src/plugins/*`: スキーマレジストリとゲート制御を追加する。
- `src/cli` における CLI コマンドのゲート制御。

<div id="tests">
  ## テスト
</div>

- 未知のキーを拒否（ルート + ネストされたキー）。
- プラグインのスキーマ欠如 → わかりやすいエラーとともにプラグインの読み込みをブロック。
- 無効な設定 → 診断コマンドを除き、Gateway の起動をブロック。
- Doctor はデフォルトでドライランを実行；`doctor --fix` は修正済みの設定を書き込む。